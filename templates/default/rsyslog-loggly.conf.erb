# This file was generated by Chef

$MainMsgQueueDiscardMark 10000
$MainMsgQueueDiscardSeverity 0

<% if @monitor_files %>
$ModLoad imfile

  <% node['loggly']['log_files'].each do |logfile| %>
$InputFileName <%= logfile['filename'] %>
$InputFileTag <%= logfile['tag'] %>:
$InputFileStateFile <%= logfile['statefile'] %>
$InputRunFileMonitor
$InputFileFacility local0 #This is the default, it's included for clarity

  <% end %>

  <% node['loggly']['log_dirs'].each do |logdir| %>
    <% Dir.foreach(logdir['directory']) do |filename| %>
      <% if filename =~ /[\w\.-_\d]+\.log$/ %>
$InputFileName <%= "#{logdir['directory']}/#{filename}" %>
$InputFileTag <%= logdir['tag'] %>:
$InputFileStateFile state-<%= filename %>
$InputRunFileMonitor
$InputFileFacility local0 #This is the default, it's included for clarity

      <% end %>
    <% end %>
  <% end %>

$InputFilePollInterval <%= node['loggly']['rsyslog']['input_file_poll_interval'] %>
<% end %>

$template LogglyFormat,"<%%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [<%= @token %>@41058 <%= @tags %>] %msg%\n"

<% if node['loggly']['tls']['enabled'] %>
$DefaultNetstreamDriverCAFile <%= node['loggly']['tls']['cert_path'] %>/loggly_full.crt

# Makes this an In-Memory Linked List queue, with a limit of 1000, and to discard all message once the limit is reached
# This is to ensure that if loggly is down we just discard the messages rather than block the applications that are logging
# http://www.rsyslog.com/doc/queues.html
$ActionQueueType LinkedList
$ActionQueueDiscardMark 1000
$ActionQueueDiscardSeverity 0

$ActionSendStreamDriver gtls
$ActionSendStreamDriverMode 1
$ActionSendStreamDriverAuthMode x509/name
$ActionSendStreamDriverPermittedPeer *.loggly.com
<% end %>

local0.* @@<%= node['loggly']['rsyslog']['host'] %>:<%= node['loggly']['rsyslog']['port'] %>;LogglyFormat
